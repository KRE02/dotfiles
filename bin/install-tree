#!/bin/env bash
set -eu

while [ -n "${1:-}" ]; do # WRONG!!!
    case "$1" in
        -d|--diff)
            show_diff=1
            shift
            ;;
        -i|--interactive)
            force_interactive=1
            shift
            ;;
        *)
            break
            ;;
    esac
done

source="$1"; shift
dest="$1"; shift

function install_file {
    # Dry run, show diff
    if [[ -n "${show_diff:-}" ]]; then
        if [[ -f "$2" ]]; then
            diff "$1" "$2"
        else
            echo "New file $(basename "$1")"
        fi

        return
    fi

    mkdir -p "$(dirname "$2")"

    # If destination is newer than source
    if [[ "$2" -nt "$1" || -n "${force_interactive:-}" ]]; then
        if ! cmp --silent "$1" "$2"; then
            echo "Destination is newer than source."
            echo "  source: $1"
            echo "  destination: $2"

            diff "$1" "$2" || true

            echo "Action:"
            echo "  [o] Overwrite"
            echo "  [b] Backup and overwrite"
            echo "  [s] Skip"
            echo "  [a] Copy destination to source"
            echo "  [e] Edit destination and copy to source"
            echo "  [d] Open with difftool"

            while true; do
                read -p "? " yn < /dev/tty
                case "$yn" in
                    s|skip)
                        return
                        ;;
                    o|overwrite)
                        break
                        ;;
                    b|backup)
                        cp "$2" "$2.dotfiles-backup"
                        break
                        ;;
                    e|edit)
                        "$EDITOR" "$2" && {
                            cp -f "$2" "$1"
                        }
                        return
                        ;;
                    a|apply|apply-back)
                        cp -f "$2" "$1"
                        return
                        ;;
                    d|diff)
                        if [ -n "${DIFFTOOL:-}" ]; then
                            "$DIFFTOOL" "$1" "$2"
                        elif hash nvim 2> /dev/null; then
                            nvim -d "$1" "$2"
                        elif hash vimdiff 2> /dev/null; then
                            vimdiff "$1" "$2"
                        else
                            echo "No difftool found! Set DIFFTOOL first."
                            return
                        fi

                        continue
                        ;;
                    *)
                        echo "Invalid action!"
                        ;;
                esac
            done
        fi
    fi

    # Copy file
    install "$1" "$2"
}

find "$source" -type f | {
    mapfile -t files

    for f in "${files[@]}"; do
        install_file "$f" "$dest/$(realpath --relative-to "$source" "$f")"
    done
}
