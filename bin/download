#!/bin/env bash
set -eu

DOTFILES_CACHE="${DOTFILES_CACHE:-$(mktemp -d)}"

url="$1"
file="$2"
md5="${3:-}"
cache_file="$DOTFILES_CACHE/$file"

function check_sum {
    if [[ -z "$md5" ]]; then
        return
    fi

    local file_sum="$(md5sum "$1" | cut -d' ' -f1)"
    if [[ "$file_sum" == "$md5" ]]; then
        echo ""
    else
        echo "error"
    fi
}

if [[ -f "$cache_file" ]]; then
    if [[ -z "$(check_sum "$cache_file")" ]]; then
        echo "$cache_file"
        exit 0
    fi
fi

wget -q "$url" -O "$cache_file"
if [[ -n "$(check_sum "$cache_file")" ]]; then
    exit 1
fi

echo "$cache_file"
