#!/bin/bash
set -euo pipefail

# Pass version number
VERSION="${1:-}"

# Pass git branch (e.g. 'branch/early-access')
BRANCH="${2:-master}"

if [[ -z "$VERSION" ]]; then
    echo "fetching latest version..."
    LATEST="$(curl "https://raw.githubusercontent.com/flathub/com.bitwig.BitwigStudio/${BRANCH:-master}/com.bitwig.BitwigStudio.yaml" -s | perl -ne 'print "$1\n" if /.*url:.*id=(.*)&.*/')"
    # LATEST="461" # 4.1
    
    VERSION="$(read -rp "version ($LATEST): ")"
    if [[ -z "$VERSION" ]]; then
        VERSION="$LATEST"
    fi
fi

URL="https://www.bitwig.com/dl/?id=${VERSION}&os=installer_linux"
DLNAME="bitwig-$VERSION.deb"

cd "$HOME/Downloads" || exit 1

if [[ ! -f "$HOME/Downloads/$DLNAME" ]];
then
    echo "downloading bitwig ${VERSION}..."
    wget "$URL" -O "bitwig-${VERSION}.deb" 1> /dev/null
fi

echo "extracting bitwig ${VERSION}..."
sudo dpkg-deb -vx "bitwig-${VERSION}.deb" /

if ! hash yabridgectl 2>/dev/null;
then
    echo "enabling copr repo patrickl/yabridge"
    sudo dnf copr enable patrickl/yabridge -y >/dev/null

    echo "installing yabridge"
    sudo dnf install yabridge -y >/dev/null

    mkdir -p ~/.vst
    yabridgectl add ~/.vst
    mkdir -p ~/.vst3
    yabridgectl add ~/.vst3
fi
